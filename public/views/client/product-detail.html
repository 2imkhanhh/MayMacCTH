<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết sản phẩm - May Mặc CTH</title>
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/product-detail.css">
</head>

<body>
    <!-- Top Header -->
    <div class="top-header bg-white border-bottom">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="dropdown me-4">
                        <button class="btn btn-sm p-0 text-muted d-flex align-items-center" type="button"
                            aria-expanded="false">

                            <img src="../../assets/images/vietnam-flag.png" id="currentFlag"
                                style="width: 20px; height: 20px; object-fit: cover; border-radius: 3px;">
                            <span id="currentLang" class="ms-1">VN</span>
                        </button>

                        <!-- <ul class="dropdown-menu" aria-labelledby="languageDropdown" style="min-width: 120px;">
                            <li>
                                <a class="dropdown-item d-flex align-items-center choose-lang" data-lang="VN"
                                    data-flag="asset/images/vietnam-flag.png" href="#">
                                    <img src="asset/images/vietnam-flag.png"
                                        style="width: 22px; height: 22px; object-fit: cover; border-radius: 3px;">
                                    <span class="ms-2">VN</span>
                                </a>
                            </li>

                            <li>
                                <a class="dropdown-item d-flex align-items-center choose-lang" data-lang="EN"
                                    data-flag="asset/images/us-flag.png" href="#">
                                    <img src="asset/images/us-flag.png"
                                        style="width: 22px; height: 22px; object-fit: cover; border-radius: 3px;">
                                    <span class="ms-2">EN</span>
                                </a>
                            </li>
                        </ul> -->
                    </div>
                    <span class="text-muted me-3"></span>
                    <!-- <a href="tel:+0783157988" class="text-muted me-4">
                        <i class="bx bx-phone-call me-1"></i> 0783 157 988
                    </a> -->
                    <span class="text-muted me-4">
                        <i class="bx bx-phone-call me-1"></i> 0783 157 988
                    </span>
                </div>
                <!-- <a href="#" class="text-muted">
                    <i class="bx bx-git-compare me-1"></i> So sánh
                </a> -->
                <span class="text-muted">
                    <i class="bx bx-git-compare me-1"></i> So sánh
                </span>
            </div>
        </div>
    </div>

    <!-- Search Bar - CẬP NHẬT Ô TÌM KIẾM MỚI -->
    <div class="search-bar bg-white py-2">
        <div class="container">
            <div class="d-flex align-items-center justify-content-between">

                <a href="../../views/client/index.html"> <img src="../../assets/images/logo.png" alt="Logo" height="60"
                        class="me-32"></a>
                <div class="d-flex align-items-center">
                    <select class="form-select category-select" id="categorySelect">
                        <option value="">Tất cả</option>
                        <option value="uniform-shirts">Áo đồng phục</option>
                        <option value="uniform-pants">Quần đồng phục</option>
                    </select>

                    <div class="search-container">
                        <input type="text" class="form-control search-input" placeholder="Tìm kiếm sản phẩm..."
                            aria-label="Search">
                        <button class="search-button" type="button">
                            <i class='bx bx-search'></i>
                        </button>
                    </div>
                </div>

                <a href="tel:+0783157988" class="btn btn-outline-primary px-4">
                    <i class="bx bx-phone-call me-1"></i> 0783 157 988
                </a>
            </div>
        </div>
    </div>

    <!-- Menu -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto align-items-center">
                    <!-- Custom dropdown danh mục -->
                    <li class="nav-item dropdown-custom me-4">
                        <a href="#" class="nav-link text-warning d-flex align-items-center">
                            <i class="bx bx-menu me-2"></i> TẤT CẢ DANH MỤC
                        </a>
                        <ul class="dropdown-menu-custom">
                            <li><a href="#">Áo đồng phục</a></li>
                            <li><a href="#">Áo thể thao</a></li>
                            <li><a href="#">Áo + Logo áo</a></li>
                            <li><a href="#">BST + Logo áo</a></li>
                            <li><a href="#">Đồng phục công giáo</a></li>
                            <li><a href="#">Đồng phục công sở</a></li>
                            <li><a href="#">Đồng phục học tập</a></li>
                            <li><a href="#">Đồng phục mùa non</a></li>
                        </ul>
                    </li>

                    <!-- Các mục menu khác -->
                    <li class="nav-item"><a class="nav-link" href="../../views/client/index.html">Trang chủ</a></li>
                    <li class="nav-item"><a class="nav-link" href="../../views/client/about-us.html">Về chúng tôi</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="../../views/client/products.html">Sản phẩm</a></li>
                    <li class="nav-item"><a class="nav-link" href="../../views/client/guide.html">Hướng dẫn</a></li>
                    <li class="nav-item"><a class="nav-link" href="../../views/client/news.html">Tin tức</a></li>
                    <li class="nav-item"><a class="nav-link" href="../../views/client/contact.html">Liên hệ</a></li>
                </ul>

                <!-- Icon bên phải -->
                <ul class="navbar-nav ms-3">
                    <li class="nav-item">
                        <a class="nav-link" href="../../views/client/cart.html">
                            <i class="bx bx-cart"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content: Product Detail Section -->
    <section class="product-detail">
        <div class="title-section">
            <div class="container d-flex justify-content-between align-items-center flex-wrap">
                <div class="page-title" id="categoryTitle">ĐANG TẢI...</div>
                <div class="breadcrumb-nav" id="breadcrumb">
                    Trang chủ > <a href="products.html">Sản phẩm</a> > <span id="productNameBreadcrumb">...</span>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row align-items-start">
                <!-- Ảnh sản phẩm -->
                <div class="col-12 col-md-6 mb-4 mb-md-0">
                    <div class="product-image">
                        <img src="" alt="Đang tải..." id="main-product-image" class="w-100"
                            style="background:#f5f5f5; min-height:400px; object-fit:contain;">

                        <div class="thumbnail-images mt-3 d-flex gap-2 flex-wrap" id="thumbnailContainer">
                            <!-- Thumbnail sẽ được load bằng JS -->
                        </div>
                    </div>

                    <!-- Accordion chi tiết -->
                    <div class="accordion product-info-accordion mt-4" id="productDetailsAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseDetails">
                                    Chi tiết sản phẩm
                                </button>
                            </h2>
                            <div id="collapseDetails" class="accordion-collapse collapse">
                                <div class="accordion-body" id="productDescription">
                                    Đang tải mô tả...
                                </div>
                            </div>
                        </div>
                        <!-- FAQ giữ nguyên như cũ -->
                    </div>
                </div>

                <!-- Thông tin sản phẩm -->
                <div class="col-12 col-md-6">
                    <div class="product-info">
                        <h1 class="product-title mb-0" id="productName">Đang tải sản phẩm...</h1>

                        <div class="price-range mb-4">
                            <span class="price h3 fw-bold text-danger" id="productPrice">0đ</span>
                        </div>

                        <div class="product-meta mb-4 text-muted small">
                            <div><strong>Mã sản phẩm:</strong> <span id="productSku">SP00</span></div>
                            <div><strong>Danh mục:</strong> <span id="productCategory">-</span></div>
                        </div>

                        <!-- Màu sắc (nếu có) -->
                        <div class="color-options mb-4" id="colorOptions" style="display: none;">
                            <h6 class="fw-bold mb-2">Màu sắc</h6>
                            <div class="color-swatches d-flex gap-2" id="colorSwatches"></div>
                        </div>

                        <!-- Kích thước -->
                        <div class="size-options mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="fw-bold mb-0">Kích thước</h6>
                                <a href="#" class="size-guide text-primary small">Hướng dẫn chọn size</a>
                            </div>
                            <div class="size-buttons d-flex gap-2" id="sizeButtons">
                                <button class="btn btn-outline-secondary btn-size active" data-size="M">M</button>
                                <!-- JS sẽ fill nếu có size từ DB -->
                            </div>
                        </div>

                        <!-- Số lượng + nút -->
                        <div class="quantity mb-4">
                            <h6 class="fw-bold mb-2">Số lượng</h6>
                            <div class="input-group w-50">
                                <button class="btn btn-outline-secondary" type="button" id="decrease">-</button>
                                <input type="text" class="form-control text-center fw-bold" value="1" readonly
                                    id="quantityInput">
                                <button class="btn btn-outline-secondary" type="button" id="increase">+</button>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn btn-add-cart" id="addToCartBtn">
                                Thêm vào giỏ hàng
                            </button>
                            <button class="btn btn-buy" id="orderBtn">
                                Mua ngay
                            </button>
                        </div>

                        <!-- <div class="product-description-wrapper mt-4 pt-3">
                            <div class="section-title-container">
                                <h2 class="section-title">Mô tả sản phẩm</h2>
                            </div>
                            <div class="product-description-content mt-3" id="shortDescription">
                                Đang tải...
                            </div>
                        </div> -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- size table -->
    <div class="modal fade" id="sizeGuideModal" tabindex="-1" aria-labelledby="sizeGuideLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sizeGuideLabel">HƯỚNG DẪN CHỌN SIZE</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="text-center">
                    <img src="../../assets/images/size-table.png" alt="Bảng size" class="img-fluid rounded shadow">
                </div>
            </div>
        </div>
    </div>

    <div class="container my-4">
        <hr class="section-divider">
    </div>

    <!-- review -->
    <section class="product-reviews-section">
        <div class="container">
            <div class="reviews-header">
                <h2 class="reviews-main-title">Đánh giá sản phẩm</h2>
                <div class="overall-rating">
                    <span class="rating-score" id="avgRating">0.0</span>
                    <div class="rating-stars text-warning" id="avgStars">
                        <i class='bx bx-star'></i> <!-- JS sẽ thay nội dung -->
                    </div>
                    <span class="review-count-text" id="reviewCountText">Dựa trên 0 khách hàng</span>
                </div>
                <div class="my-4">
                    <button class="btn btn-review px-4" data-bs-toggle="collapse" data-bs-target="#writeReviewCollapse">
                        <i class='bx bxs-edit-alt'></i> Viết đánh giá
                    </button>
                </div>
            </div>
            <div class="collapse mt-4" id="writeReviewCollapse">
                <div class="p-4 border rounded bg-light">
                    <h5 class="fw-bold mb-3">Viết đánh giá của bạn</h5>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Số điện thoại</label>
                        <input type="text" class="form-control" id="reviewPhone" placeholder="Nhập số điện thoại">
                    </div>
                    <!-- Tên khách -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Họ tên</label>
                        <input type="text" class="form-control" id="reviewName" placeholder="Nhập tên">
                    </div>

                    <!-- Số sao -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold d-block">Xếp hạng</label>
                        <div class="rating-stars-input" id="ratingStars">
                            <i class='bx bx-star' data-value="1"></i>
                            <i class='bx bx-star' data-value="2"></i>
                            <i class='bx bx-star' data-value="3"></i>
                            <i class='bx bx-star' data-value="4"></i>
                            <i class='bx bx-star' data-value="5"></i>
                        </div>
                    </div>

                    <!-- Size -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Kích thước bạn đã mua</label>
                        <select class="form-select" id="reviewSize">
                            <option value="">Chọn size</option>
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                        </select>
                    </div>

                    <!-- Màu -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Màu sắc</label>
                        <input type="text" class="form-control" id="reviewColor" placeholder="VD: Đen, Trắng, Đỏ,...">
                    </div>

                    <!-- Nội dung -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Nội dung đánh giá</label>
                        <textarea class="form-control" rows="4" id="reviewContent"
                            placeholder="Chia sẻ trải nghiệm của bạn..."></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-semibold">Chọn tag phù hợp với trải nghiệm của bạn <small
                                class="text-muted">(có thể chọn nhiều)</small></label>
                        <div class="review-tag-selection d-flex flex-wrap gap-2" id="reviewTagContainer">
                            <div class="text-center py-5 text-muted w-100">
                                <i class='bx bx-loader-alt bx-spin'></i> Đang tải tag...
                            </div>
                        </div>
                    </div>

                    <!-- Upload ảnh -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Thêm hình ảnh (tối đa 5)</label>
                        <input type="file" class="form-control" id="reviewImages" accept="image/*" multiple>
                        <div id="previewImages" class="d-flex gap-2 mt-2 flex-wrap"></div>
                    </div>

                    <!-- Nút gửi + nút hủy -->
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary px-4" id="submitReview">Gửi đánh giá</button>
                        <button class="btn btn-outline-secondary" data-bs-toggle="collapse"
                            data-bs-target="#writeReviewCollapse">Hủy</button>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12 col-lg-4">
                    <div class="review-filters">
                        <h6 class="filter-title">Lọc đánh giá</h6>
                        <div class="input-group search-reviews mb-4">
                            <span class="input-group-text">
                                <i class='bx bx-search'></i>
                            </span>
                            <input type="text" class="form-control" placeholder="Tìm kiếm đánh giá">
                        </div>

                        <h6 class="filter-title">Phân loại xếp hạng</h6>
                        <ul class="filter-list star-filter-list">
                            <li>
                                <button class="btn btn-filter-star active">
                                    5 <i class='bx bxs-star'></i>
                                </button>
                            </li>
                            <li>
                                <button class="btn btn-filter-star">
                                    4 <i class='bx bxs-star'></i>
                                </button>
                            </li>
                            <li>
                                <button class="btn btn-filter-star">
                                    3 <i class='bx bxs-star'></i>
                                </button>
                            </li>
                            <li>
                                <button class="btn btn-filter-star">
                                    2 <i class='bx bxs-star'></i>
                                </button>
                            </li>
                            <li>
                                <button class="btn btn-filter-star">
                                    1 <i class='bx bxs-star'></i>
                                </button>
                            </li>
                        </ul>

                        <h6 class="filter-title mt-4">Lọc phản hồi</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="checkHasFeedback">
                            <label class="form-check-label" for="checkHasFeedback">
                                Đã phản hồi
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="" id="checkHasImage">
                            <label class="form-check-label" for="checkHasImage">
                                Có hình ảnh
                            </label>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-8 mt-4 mt-lg-0">
                    <div class="review-list" id="reviewList">
                        <div class="text-center py-5" id="loadingReviews">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-3">Đang tải đánh giá...</p>
                        </div>
                        <div id="noReviews" class="text-center py-5 text-muted" style="display:none;">
                            Chưa có đánh giá nào cho sản phẩm này.
                        </div>
                    </div>

                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="reviewPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </section>

    <!-- <div id="addToCartToast" class="toast-notification">
        <div class="toast-icon">
            <i class="bx bx-check-circle"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">Thêm vào giỏ hàng thành công!</div>
            <div class="toast-message" id="toastProductName">Sản phẩm XYZ</div>
        </div>
        <button class="toast-close">&times;</button>
    </div> -->

    <!-- Footer -->
    <footer class="footer bg-primary text-white py-5">
        <div class="container">
            <div class="row gy-4">
                <!-- Logo + Giới thiệu -->
                <div class="col-12 col-md-4 col-lg-3">
                    <a href="../../views/client/index.html"><img src="../../assets/images/logo2.png" alt="Logo"
                            class="footer-logo mb-3"></a>
                    <p class="footer-slogan">MAY MẶC CTH lắng nghe bạn!</p>
                    <p class="footer-desc">
                        Chúng tôi luôn trân trọng mọi ý kiến đóng góp của khách hàng,
                        không ngừng cải thiện để mang đến sản phẩm và dịch vụ tốt nhất.
                    </p>
                    <button class="btn btn-warning footer-btn">ĐÓNG GÓP Ý KIẾN →</button>
                    <p class="footer-tax mt-3"><strong>MÃ SỐ THUẾ:</strong> 0202167805</p>
                </div>

                <!-- Về chúng tôi -->
                <div class="col-6 col-md-4 col-lg-2">
                    <p class="footer-title">VỀ CHÚNG TÔI</p>
                    <ul class="footer-links">
                        <li><a href="#">Giới thiệu MAY MẶC CTH</a></li>
                        <li><a href="#">Hướng dẫn mua hàng</a></li>
                        <li><a href="#">Hướng dẫn chọn size</a></li>
                        <li><a href="#">Chính sách đổi trả</a></li>
                        <li><a href="#">Chính sách giao hàng</a></li>
                        <li><a href="#">FAQ</a></li>
                    </ul>
                </div>

                <!-- Sản phẩm -->
                <div class="col-6 col-md-4 col-lg-2">
                    <p class="footer-title">SẢN PHẨM</p>
                    <ul class="footer-links">
                        <li><a href="#">Áo đồng phục</a></li>
                        <li><a href="#">Áo thể thao</a></li>
                        <li><a href="#">BST + Logo áo</a></li>
                        <li><a href="#">Đồng phục công giáo</a></li>
                        <li><a href="#">Đồng phục công sở</a></li>
                        <li><a href="#">Đồng phục học tập</a></li>
                    </ul>
                </div>

                <!-- Tin tức -->
                <div class="col-6 col-md-6 col-lg-2">
                    <p class="footer-title">TIN TỨC</p>
                    <ul class="footer-links">
                        <li><a href="#">Xu hướng thời trang</a></li>
                        <li><a href="#">Sức khỏe & Đời sống</a></li>
                        <li><a href="#">Bí mật Gạo House</a></li>
                        <li><a href="#">Mẹo hay MAY MẶC</a></li>
                        <li><a href="#">Tin tức</a></li>
                    </ul>
                </div>

                <!-- Thông tin liên hệ + Nút liên hệ -->
                <div class="col-12 col-md-12 col-lg-3">
                    <p class="footer-title mb-3">THÔNG TIN LIÊN HỆ</p>

                    <!-- Dùng flex để icon và chữ luôn thẳng hàng -->
                    <div class="d-flex align-items-start mb-2">
                        <i class='bx bx-map text-warning me-3' style="font-size: 1.4rem; min-width: 26px;"></i>
                        <span id="footerAddress" class="text-white">Đang tải địa chỉ...</span>
                    </div>

                    <div class="d-flex align-items-start mb-2">
                        <i class='bx bx-globe text-success me-3' style="font-size: 1.4rem; min-width: 26px;"></i>
                        <span id="footerWebsite" class="text-white">Đang tải website...</span>
                    </div>

                    <div class="d-flex align-items-start mb-4">
                        <i class='bx bx-phone text-danger me-3' style="font-size: 1.4rem; min-width: 26px;"></i>
                        <span id="footerPhone" class="text-white">Đang tải số điện thoại...</span>
                    </div>

                    <!-- Nút liên hệ giữ nguyên -->
                    <div class="footer-contact-btns mt-3">
                        <a href="https://zalo.me/078315798" class="contact-card">
                            <div class="contact-icon"><img src="../../assets/images/zalo.png" alt="Zalo"></div>
                            <div class="contact-text"><span class="contact-label">TƯ VẤN QUA</span><span
                                    class="contact-value">ZALO</span></div>
                        </a>
                        <a href="tel:+078315798" class="contact-card">
                            <div class="contact-icon"><img src="../../assets/images/hotline.png" alt="Hotline"></div>
                            <div class="contact-text"><span class="contact-label">HOTLINE</span><span
                                    class="contact-value">0783 157 98</span></div>
                        </a>
                        <a href="tel:+078315798" class="contact-card">
                            <div class="contact-icon"><img src="../../assets/images/hotline.png" alt="Tại cửa hàng">
                            </div>
                            <div class="contact-text"><span class="contact-label">TẠI CỬA HÀNG</span><span
                                    class="contact-value">078315798</span></div>
                        </a>
                    </div>
                </div>
            </div>
            <hr class="footer-divider my-4">

            <!-- Thanh toán -->
            <div class="row">
                <div class="col text-center">
                    <p class="mb-2 footer-title">PHƯƠNG THỨC THANH TOÁN</p>
                    <div class="d-flex justify-content-center align-items-center gap-3">
                        <img src="../../assets/images/cash.png" height="30" alt="Cash">
                        <img src="../../assets/images/mastercard.png" height="30" alt="Mastercard">
                        <img src="../../assets/images/visa.png" height="30" alt="Visa">
                    </div>
                </div>
            </div>

            <!-- <p class="text-center mt-4 small mb-0">&copy; 2025 MAY MẶC CTH. All rights reserved.</p> -->
        </div>
    </footer>
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const BASE_URL = '/MayMacCTH';
            let uploadedImageNames = [];
            // ==================== 2. LOAD + HIỂN THỊ TAG ====================
            async function loadReviewTags() {
                const container = document.getElementById('reviewTagContainer');
                if (!container) return;

                try {
                    const res = await fetch(`${BASE_URL}/api/review_tags/get_review_tags.php`);
                    const result = await res.json();

                    if (result.success && result.data?.length > 0) {
                        const activeTags = result.data.filter(t => t.is_active == 1);
                        container.innerHTML = '';
                        activeTags.forEach(tag => {
                            const btn = document.createElement('div');
                            btn.className = 'tag-select';
                            btn.textContent = tag.content;
                            btn.dataset.tagId = tag.review_tag_id;
                            btn.onclick = () => btn.classList.toggle('selected');
                            container.appendChild(btn);
                        });
                    } else {
                        container.innerHTML = '<div class="text-muted">Chưa có tag nào.</div>';
                    }
                } catch (err) {
                    console.error(err);
                    container.innerHTML = '<div class="text-danger">Lỗi tải tag!</div>';
                }
            }
            await loadReviewTags();

            // ==================== 4. UPLOAD ẢNH + PREVIEW ====================
            const previewContainer = document.getElementById('previewImages');
            document.getElementById('reviewImages')?.addEventListener('change', e => {
                const files = e.target.files;
                uploadedImageNames = [];
                previewContainer.innerHTML = '';

                if (files.length > 5) {
                    alert('Tối đa 5 ảnh thôi nhé!');
                    e.target.value = '';
                    return;
                }

                Array.from(files).forEach((file, i) => {
                    if (!file.type.startsWith('image/')) return;

                    const fileName = `review_${Date.now()}_${i}_${file.name}`;
                    uploadedImageNames.push(fileName);

                    const reader = new FileReader();
                    reader.onload = ev => {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'position-relative me-2 mb-2';

                        const img = document.createElement('img');
                        img.src = ev.target.result;
                        img.style.cssText = 'width:100px;height:100px;object-fit:cover;border-radius:8px;border:2px solid #ddd;';

                        const remove = document.createElement('button');
                        remove.innerHTML = '×';
                        remove.style.cssText = 'position:absolute;top:4px;right:4px;width:24px;height:24px;border-radius:50%;background:rgba(0,0,0,0.7);color:white;border:none;font-size:18px;cursor:pointer;';
                        remove.onclick = () => {
                            uploadedImageNames = uploadedImageNames.filter(n => n !== fileName);
                            wrapper.remove();
                        };

                        wrapper.appendChild(img);
                        wrapper.appendChild(remove);
                        previewContainer.appendChild(wrapper);
                    };
                    reader.readAsDataURL(file);
                });
            });

            // ==================== 6. CÁC HÀM KHÁC (giỏ hàng, footer…) ====================
            updateCartCount();

            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            const contentContainer = document.querySelector('.product-detail > .container');

            contentContainer.innerHTML = '<div class="text-center py-5"><h1>Đang tải sản phẩm...</h1></div>';

            if (!productId || isNaN(productId)) {
                contentContainer.innerHTML = '<div class="text-center py-5"><h1 class="text-danger">ID không hợp lệ!</h1></div>';
                return;
            }

            try {
                const res = await fetch(`${BASE_URL}/api/product/get_product.php`);
                if (!res.ok) throw new Error('Lỗi server');
                const result = await res.json();
                if (!result.success || !result.data?.length) throw new Error('Không có sản phẩm');

                const p = result.data.find(item => item.product_id == productId);
                if (!p) throw new Error('Sản phẩm không tồn tại');

                // Cập nhật tiêu đề + breadcrumb
                const categoryTitleEl = document.getElementById('categoryTitle');
                const breadcrumbEl = document.getElementById('productNameBreadcrumb');
                if (categoryTitleEl) categoryTitleEl.textContent = p.category_name || 'SẢN PHẨM';
                if (breadcrumbEl) breadcrumbEl.textContent = p.name;

                // Render nội dung + phần chính sách ĐẸP CHUẨN
                contentContainer.innerHTML = `
                    <div class="row align-items-start">
                        <!-- Ảnh sản phẩm -->
                        <div class="col-12 col-md-6 mb-4 mb-md-0">
                            <div class="product-image">
                                <img src="" alt="${p.name}" id="main-product-image" class="w-100"
                                    style="background:#f5f5f5; min-height:400px; object-fit:contain;">
                                <div class="thumbnail-images mt-3 d-flex gap-2 flex-wrap" id="thumbnailContainer"></div>
                            </div>

                            <div class="accordion product-info-accordion mt-4">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                            data-bs-target="#collapseDetails">
                                            Chi tiết sản phẩm
                                        </button>
                                    </h2>
                                    <div id="collapseDetails" class="accordion-collapse collapse">
                                        <div class="accordion-body">
                                            ${p.description ? p.description.replace(/\n/g, '<br>') : 'Chưa có mô tả chi tiết.'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Thông tin sản phẩm -->
                        <div class="col-12 col-md-6">
                            <div class="product-info">
                                <h1 class="product-title mb-0">${p.name}</h1>
                                <div class="price-range mb-4">
                                    <span class="price h3 fw-bold text-danger">
                                        ${parseInt(p.price || 0).toLocaleString('vi-VN')}đ
                                    </span>
                                </div>
                                <div class="product-meta mb-4 text-muted small">
                                    <div><strong>Mã sản phẩm:</strong> SP${String(p.product_id).padStart(4, '0')}</div>
                                    <div><strong>Danh mục:</strong> ${p.category_name || 'Chưa xác định'}</div>
                                </div>

                                <!-- MÀU SẮC -->
                                ${p.colors && p.colors.length ? `
                                <div class="color-options mb-4">
                                    <h6 class="fw-bold mb-2">Màu sắc</h6>
                                    <div class="color-swatches d-flex gap-2 flex-wrap" id="colorSwatches"></div>
                                </div>` : ''}

                                <!-- KÍCH THƯỚC -->
                                <div class="size-options mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="fw-bold mb-0">Kích thước</h6>
                                        <a href="#" class="size-guide text-primary small">Hướng dẫn chọn size</a>
                                    </div>
                                    <div class="size-buttons d-flex gap-2 flex-wrap" id="sizeButtons"></div>
                                </div>

                                <div class="quantity mb-4">
                                    <h6 class="fw-bold mb-2">Số lượng</h6>
                                    <div class="input-group w-50">
                                        <button class="btn btn-outline-secondary" type="button" id="decrease">-</button>
                                        <input type="text" class="form-control text-center fw-bold" value="1" readonly id="quantityInput">
                                        <button class="btn btn-outline-secondary" type="button" id="increase">+</button>
                                    </div>
                                </div>

                                <div class="action-buttons mb-5">
                                    <button class="btn btn-add-cart" id="addToCartBtn">Thêm vào giỏ hàng</button>
                                    <button class="btn btn-buy" id="orderBtn">Mua ngay</button>
                                </div>

                                <!-- Dịch vụ -->
                                <div class="product-description-wrapper mt-4 pt-3 border-bottom">
                                    <h2 class="section-title">Dịch vụ của chúng tôi</h2>
                                </div>
                                <!-- PHẦN CHÍNH SÁCH HỖ TRỢ - ĐẸP Y CHANG BẠN MUỐN -->
                                <div class="policy-wrapper mt-5">
                                    <div class="row g-4">
                                        <div class="col-12 col-md-6">
                                            <div class="policy-item">
                                                <div class="policy-icon-box text-box">
                                                    <span>FREE</span>
                                                    <span>SHIP</span>
                                                </div>
                                                <div class="policy-content">
                                                    <span class="policy-title">Free ship cho đơn trên 200k</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-12 col-md-6">
                                            <div class="policy-item">
                                                <div class="policy-icon-box">
                                                    <i class='bx bx-sync'></i>
                                                </div>
                                                <div class="policy-content">
                                                    <span class="policy-title">30 ngày đổi trả cho bất kì thứ gì</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-12 col-md-6">
                                            <div class="policy-item">
                                                <div class="policy-icon-box">
                                                    <i class='bx bx-phone-call'></i>
                                                </div>
                                                <div class="policy-content">
                                                    <span class="policy-title">Hotline hỗ trợ 0783159798</span>
                                                    <span class="policy-sub">hỗ trợ từ 8h30 - 22h</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-12 col-md-6">
                                            <div class="policy-item">
                                                <div class="policy-icon-box">
                                                    <i class='bx bx-map-pin'></i>
                                                </div>
                                                <div class="policy-content">
                                                    <span class="policy-title">Đến tận nơi nhận trả hàng</span>
                                                    <span class="policy-sub">hoàn tiền trong 24h</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // ==================== ẢNH ====================
                const mainImg = document.getElementById('main-product-image');
                const thumbContainer = document.getElementById('thumbnailContainer');
                thumbContainer.innerHTML = '';

                let allImages = [];
                if (p.images && Array.isArray(p.images)) {
                    allImages = p.images.map(i => typeof i === 'object' ? i.image : i).filter(Boolean);
                }
                if (!allImages.length && p.primary_image) allImages.push(p.primary_image);
                if (!allImages.length) allImages.push('no-image.jpg');

                allImages.forEach((img, i) => {
                    const src = `../../assets/images/upload/${img}`;
                    if (i === 0) mainImg.src = src;

                    const thumb = document.createElement('img');
                    thumb.src = src;
                    thumb.alt = p.name;
                    thumb.className = 'thumbnail';
                    thumb.style.cssText = 'width:80px;height:80px;object-fit:cover;cursor:pointer;border:2px solid #eee;border-radius:8px;';
                    if (i === 0) thumb.classList.add('active');
                    thumb.onclick = () => {
                        mainImg.src = src;
                        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                        thumb.classList.add('active');
                    };
                    thumbContainer.appendChild(thumb);
                });

                // ==================== MÀU + SIZE ====================
                if (p.colors && p.colors.length) {
                    const colorSwatches = document.getElementById('colorSwatches');
                    p.colors.forEach((color, idx) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn border position-relative';
                        btn.style.backgroundColor = color.color_code || '#ccc';
                        btn.style.width = '44px';
                        btn.style.height = '44px';
                        btn.title = color.color_name;
                        if (idx === 0) btn.classList.add('active', 'border-primary');

                        const span = document.createElement('span');
                        span.className = 'position-absolute top-50 start-50 translate-middle text-white fw-bold';
                        span.style.fontSize = '10px';
                        span.textContent = color.color_name.substring(0, 3).toUpperCase();
                        btn.appendChild(span);

                        btn.onclick = () => {
                            colorSwatches.querySelectorAll('button').forEach(b => b.classList.remove('active', 'border-primary'));
                            btn.classList.add('active', 'border-primary');
                            updateSizes(color.sizes || []);
                        };
                        colorSwatches.appendChild(btn);
                    });
                    updateSizes(p.colors[0].sizes || []);
                } else {
                    document.getElementById('sizeButtons').innerHTML = '<span class="text-muted">Không có size</span>';
                }

                function updateSizes(sizes) {
                    const sizeButtons = document.getElementById('sizeButtons');
                    sizeButtons.innerHTML = '';
                    if (!sizes?.length) {
                        sizeButtons.innerHTML = '<span class="text-muted">Không có size</span>';
                        return;
                    }
                    sizes.forEach((size, idx) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'btn btn-outline-secondary btn-size';
                        btn.textContent = size;
                        if (idx === 0) btn.classList.add('active');
                        btn.onclick = () => {
                            sizeButtons.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                        };
                        sizeButtons.appendChild(btn);
                    });
                }

                // Nút chức năng
                document.getElementById('increase')?.addEventListener('click', () => {
                    const input = document.getElementById('quantityInput');
                    input.value = parseInt(input.value) + 1;
                });
                document.getElementById('decrease')?.addEventListener('click', () => {
                    const input = document.getElementById('quantityInput');
                    if (parseInt(input.value) > 1) input.value = parseInt(input.value) - 1;
                });
                document.getElementById('addToCartBtn')?.addEventListener('click', function () {
                    // Lấy thông tin đã chọn
                    const selectedColorBtn = document.querySelector('#colorSwatches .btn.active');
                    const selectedSizeBtn = document.querySelector('#sizeButtons .btn-size.active');
                    const quantity = parseInt(document.getElementById('quantityInput').value) || 1;

                    // Kiểm tra chọn màu và size (nếu có)
                    if (p.colors && p.colors.length && !selectedColorBtn) {
                        alert('Vui lòng chọn màu sắc!');
                        return;
                    }
                    if (!selectedSizeBtn) {
                        alert('Vui lòng chọn kích thước!');
                        return;
                    }

                    const colorName = selectedColorBtn ? selectedColorBtn.title : 'Không có màu';
                    const size = selectedSizeBtn ? selectedSizeBtn.dataset.size || selectedSizeBtn.textContent : 'Freesize';
                    const price = parseInt(p.price || 0);
                    const image = document.getElementById('main-product-image').src;

                    // Tạo object sản phẩm để thêm vào giỏ
                    const cartItem = {
                        id: p.product_id,
                        name: p.name,
                        price: price,
                        quantity: quantity,
                        color: colorName,
                        size: size,
                        image: image.includes('upload/') ? image.split('/').pop() : 'no-image.jpg', // lưu tên file ảnh
                        uniqueKey: `${p.product_id}-${colorName}-${size}` // key duy nhất để tránh trùng
                    };

                    // Lấy giỏ hàng hiện tại từ localStorage
                    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

                    // Kiểm tra sản phẩm (cùng id + màu + size) đã có chưa
                    const existingIndex = cart.findIndex(item => item.uniqueKey === cartItem.uniqueKey);

                    if (existingIndex !== -1) {
                        // Nếu đã có → tăng số lượng
                        cart[existingIndex].quantity += quantity;
                        alert(`Đã cập nhật số lượng: ${p.name} (${colorName}, ${size})`);
                    } else {
                        // Nếu chưa có → thêm mới
                        cart.push(cartItem);
                        alert(`Đã thêm vào giỏ hàng: ${p.name}`);
                    }

                    // Lưu lại vào localStorage
                    localStorage.setItem('cart', JSON.stringify(cart));

                    // Optional: Cập nhật số lượng giỏ hàng trên header (nếu bạn có icon giỏ hàng)
                    updateCartCount();
                });
                document.getElementById('orderBtn')?.addEventListener('click', function () {
                    // Lấy thông tin đã chọn
                    const selectedColorBtn = document.querySelector('#colorSwatches .btn.active');
                    const selectedSizeBtn = document.querySelector('#sizeButtons .btn-size.active');
                    const quantity = parseInt(document.getElementById('quantityInput').value) || 1;

                    // Kiểm tra bắt buộc chọn màu & size
                    if (p.colors && p.colors.length && !selectedColorBtn) {
                        alert('Vui lòng chọn màu sắc!');
                        return;
                    }
                    if (!selectedSizeBtn) {
                        alert('Vui lòng chọn kích thước!');
                        return;
                    }

                    const colorName = selectedColorBtn ? selectedColorBtn.title : null;
                    const size = selectedSizeBtn ? selectedSizeBtn.textContent : 'Freesize';
                    const price = parseInt(p.price || 0);
                    const image = document.getElementById('main-product-image').src.split('/').pop();

                    // Tạo object sản phẩm
                    const buyNowItem = {
                        id: p.product_id,
                        name: p.name,
                        price: price,
                        quantity: quantity,
                        color: colorName,
                        size: size,
                        image: image || 'no-image.jpg',
                        uniqueKey: `${p.product_id}-${colorName || 'no-color'}-${size}`
                    };

                    // XÓA GIỎ HÀNG CŨ → CHỈ GIỮ RIÊNG SẢN PHẨM NÀY
                    localStorage.setItem('cart', JSON.stringify([buyNowItem]));

                    // CHUYỂN NGAY QUA TRANG ĐẶT HÀNG
                    window.location.href = '../client/order.html';
                });
                document.querySelector('.size-guide')?.addEventListener('click', e => {
                    e.preventDefault();
                    new bootstrap.Modal(document.getElementById('sizeGuideModal')).show();
                });

                document.title = `${p.name} - May Mặc CTH`;

            } catch (err) {
                console.error(err);
                contentContainer.innerHTML = `<div class="text-center py-5"><h1 class="text-danger">Lỗi tải sản phẩm</h1><p>${err.message}</p><button class="btn btn-primary" onclick="location.reload()">Tải lại</button></div>`;
            }

            const addressEl = document.getElementById('footerAddress');
            const websiteEl = document.getElementById('footerWebsite');
            const phoneEl = document.getElementById('footerPhone');

            if (!addressEl && !websiteEl && !phoneEl) return;

            try {
                const res = await fetch(`${BASE_URL}/api/contact/get_contact.php?t=${Date.now()}`);
                const data = await res.json();

                if (data.success && data.data && data.data.length > 0) {
                    const c = data.data[0];

                    if (addressEl) {
                        addressEl.textContent = c.address || 'Chưa cập nhật địa chỉ';
                    }

                    if (websiteEl) {
                        if (c.website && c.website.trim()) {
                            const url = c.website.match(/^https?:\/\//i) ? c.website : 'https://' + c.website;
                            websiteEl.outerHTML = `<a href="${url}" target="_blank" class="text-white text-decoration-none">${c.website}</a>`;
                        } else {
                            websiteEl.textContent = 'Chưa có website';
                        }
                    }

                    if (phoneEl) {
                        phoneEl.textContent = c.phone_number || 'Chưa cập nhật số điện thoại';
                    }
                }
            } catch (err) {
                console.error('Lỗi load footer contact:', err);
            }

            document.getElementById('writeReviewCollapse')?.addEventListener('shown.bs.collapse', function () {
                const stars = document.querySelectorAll('#ratingStars i');

                stars.forEach((star, idx) => {
                    star.onclick = () => {
                        stars.forEach((s, i) => {
                            if (i <= idx) {
                                s.className = 'bx bxs-star';
                                s.style.color = '#f39c12';
                            } else {
                                s.className = 'bx bx-star';
                                s.style.color = '#ccc';
                            }
                        });
                    };
                });

                // Tự động focus vào ô tên
                document.getElementById('reviewName')?.focus();
            });

            // Xử lý gửi đánh giá (lấy DOM mới nhất, không bị cache)
            document.getElementById('submitReview')?.addEventListener('click', async () => {
                const name = document.getElementById('reviewName')?.value.trim();
                const phone = document.getElementById('reviewPhone')?.value.trim();
                const content = document.getElementById('reviewContent')?.value.trim();
                const rating = document.querySelectorAll('#ratingStars i.bxs-star').length;
                const size = document.getElementById('reviewSize')?.value || '';
                const color = document.getElementById('reviewColor')?.value.trim() || '';
                const files = document.getElementById('reviewImages')?.files;

                if (!name || !phone || rating === 0 || !content) {
                    alert('Vui lòng điền đầy đủ: Họ tên, SĐT, đánh giá sao và nội dung!');
                    return;
                }

                const tagIds = Array.from(document.querySelectorAll('#reviewTagContainer .tag-select.selected'))
                    .map(t => t.dataset.tagId);

                // Dùng FormData để gửi cả file + text
                const formData = new FormData();
                formData.append('product_id', new URLSearchParams(window.location.search).get('id'));
                formData.append('customer_name', name);
                formData.append('phone', phone);
                formData.append('rating', rating);
                formData.append('size', size);
                formData.append('color', color);
                formData.append('content', content);
                tagIds.forEach(id => formData.append('tag_ids[]', id));

                // Thêm ảnh (nếu có)
                if (files && files.length > 0) {
                    for (let file of files) {
                        formData.append('images[]', file);
                    }
                }

                try {
                    const res = await fetch(`${BASE_URL}/api/review_products/create_review.php`, {
                        method: 'POST',
                        body: formData
                        // KHÔNG set Content-Type → để browser tự set multipart/form-data
                    });

                    const result = await res.json();
                    alert(result.message || (result.success ? 'Gửi thành công!' : 'Có lỗi!'));

                    if (result.success) {
                        // Reset form...
                        document.getElementById('reviewName').value = '';
                        document.getElementById('reviewPhone').value = '';
                        document.getElementById('reviewContent').value = '';
                        document.getElementById('reviewSize').selectedIndex = 0;
                        document.getElementById('reviewColor').value = '';
                        document.querySelectorAll('#ratingStars i').forEach(s => {
                            s.className = 'bx bx-star';
                            s.style.color = '#ccc';
                        });
                        document.getElementById('previewImages').innerHTML = '';
                        document.getElementById('reviewImages').value = '';
                        document.querySelectorAll('#reviewTagContainer .tag-select.selected')
                            .forEach(t => t.classList.remove('selected'));

                        bootstrap.Collapse.getInstance(document.getElementById('writeReviewCollapse'))?.hide();

                        // Tải lại đánh giá mới nhất
                        loadReviews(1);
                    }
                } catch (err) {
                    console.error(err);
                    alert('Lỗi kết nối server!');
                }
            });

            async function loadReviews(page = 1) {
                const productId = new URLSearchParams(window.location.search).get('id');
                const reviewList = document.getElementById('reviewList');
                const loading = document.getElementById('loadingReviews');
                const noReviews = document.getElementById('noReviews');

                if (!productId) return;

                // Bắt đầu loading
                if (loading) loading.style.display = 'block';
                if (noReviews) noReviews.style.display = 'none';
                reviewList.innerHTML = '';

                try {
                    const url = `${BASE_URL}/api/review_products/get_reviews.php?id=${productId}&page=${page}&limit=3`;
                    const res = await fetch(url);

                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}`);
                    }

                    const result = await res.json();
                    // console.log('Dữ liệu đánh giá nhận được:', result);

                    if (result.success && result.data) {
                        renderAverageRating(result.data.average_rating || 0, result.data.total_reviews || 0);
                    }

                    if (!result.success || !result.data || !Array.isArray(result.data.reviews) || result.data.reviews.length === 0) {
                        reviewList.innerHTML = '<div class="text-center text-muted py-5">Chưa có đánh giá nào.</div>';
                        renderPagination(0, 1, 1);
                        if (loading) loading.style.display = 'none';
                        if (noReviews) noReviews.style.display = 'block';
                        return;
                    }

                    const reviews = result.data.reviews;

                    reviewList.innerHTML = reviews.map(r => `
                    <div class="review-item">
                        <div class="review-author">
                            <strong>${escapeHtml(r.customer_name || 'Khách')}</strong>
                            <span class="review-date">${r.created_at || ''}</span>
                        </div>
                    <div class="review-rating text-warning">
                        ${Array.from({ length: 5 }, (_, i) =>
                        `<i class='bx ${i < (r.rating || 0) ? 'bxs-star' : 'bx-star'}'></i>`
                    ).join('')}
                    </div>
                ${r.size || r.color ? `
                <div class="review-product-details">
                    ${r.size ? `<span>Kích thước: ${escapeHtml(r.size)}</span>` : ''}
                    ${r.color ? `<span>Màu sắc: ${escapeHtml(r.color)}</span>` : ''}
                </div>` : ''}
                <p class="review-text">${escapeHtml(r.content || '')}</p>

               ${r.images && r.images.length ? `
                <div class="review-images">
                    ${r.images.map(img => `
                        <img src="${BASE_URL}/public/assets/images/upload/${img}" 
                            alt="Ảnh đánh giá" 
                            class="img-fluid rounded me-2 mb-2" 
                            style="max-height:120px; object-fit:cover; border:1px solid #ddd;"
                            onerror="this.src='https://via.placeholder.com/100?text=No+Image'; this.onerror=null;">
                    `).join('')}
                </div>` : ''}

                ${r.tags && r.tags.length ? `
                        <div class="review-tags">
                            ${r.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>` : ''}
                    </div>
                `).join('');

                    renderPagination(
                        result.data.total_reviews || 0,
                        result.data.total_pages || 1,
                        result.data.current_page || 1
                    );

                    // Ẩn loading + hiện danh sách
                    if (loading) loading.style.display = 'none';
                    if (noReviews) noReviews.style.display = 'none';

                } catch (err) {
                    console.error('Lỗi loadReviews:', err);
                    reviewList.innerHTML = '<div class="text-danger text-center py-4">Lỗi tải đánh giá, đang thử lại...</div>';
                    if (loading) loading.style.display = 'none';
                }
            }

            function renderAverageRating(avg, total) {
                const scoreEl = document.getElementById('avgRating');
                const starsEl = document.getElementById('avgStars');
                const countEl = document.getElementById('reviewCountText');

                if (!scoreEl || !starsEl || !countEl) return;

                // Điểm trung bình
                scoreEl.textContent = Number(avg).toFixed(1);

                // Luôn 1 ngôi sao vàng (dù điểm cao hay thấp)
                starsEl.innerHTML = `<i class='bx bxs-star' style="font-size:1.5rem;"></i>`;

                // Tổng số đánh giá
                if (total > 0) {
                    countEl.textContent = `Dựa trên ${total} khách hàng`;
                } else {
                    countEl.textContent = 'Chưa có đánh giá';
                }
            }

            function renderPagination(total, totalPages, currentPage) {
                const pagination = document.getElementById('reviewPagination');
                if (totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let html = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">Trước</a>
                </li>`;

                for (let i = 1; i <= totalPages; i++) {
                    html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>`;
                }

                html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">Sau</a>
                </li>`;

                pagination.innerHTML = html;
            }

            // Xử lý click phân trang
            document.getElementById('reviewPagination')?.addEventListener('click', e => {
                e.preventDefault();
                const link = e.target.closest('a');
                if (!link || link.parentElement.classList.contains('disabled')) return;
                const page = parseInt(link.dataset.page);
                if (page > 0) {
                    loadReviews(page);
                    document.querySelector('.review-list').scrollIntoView({ behavior: 'smooth' });
                }
            });

            // Hàm escape HTML tránh XSS
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Gọi load khi trang sẵn sàng
            loadReviews(1);
        });

        // Hàm cập nhật số lượng giỏ hàng (giữ nguyên)
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const total = cart.reduce((sum, i) => sum + i.quantity, 0);
            const el = document.getElementById('cartCount');
            if (el) {
                el.textContent = total;
                el.style.display = total > 0 ? 'block' : 'none';
            }
        }
    </script>
</body>

</html>